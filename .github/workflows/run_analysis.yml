# .github/workflows/run_analysis.yml
name: AI Trend Analysis & Deploy Pages

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "选择运行模式: both / backend / frontend"
        required: false
        default: "both"
  schedule:
    - cron: "0 22 * * *" # 每天22:00自动运行

jobs:
  # ------------------------------------
  # Job 1 : 后端 Python 自动化分析
  # ------------------------------------
  run-analysis:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'both' || github.event.inputs.mode == 'backend' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -r scripts/pyproject.toml --system

      - name: Run Python Automation Pipeline
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL_NAME: ${{ vars.MODEL_NAME || 'deepseek-chat' }}
          LANGUAGE: ${{ vars.LANGUAGE || 'Chinese' }}
          TRACKED_TOPICS: ${{ vars.TRACKED_TOPICS || '' }}
        run: python -m scripts.main

  # ------------------------------------
  # Job 2 : 前端替换 + 部署 Pages
  # ------------------------------------
  deploy-pages:
    runs-on: ubuntu-latest
    needs: [run-analysis] # 静态依赖，不再动态计算

    # 用 if 来控制什么时候执行
    if: ${{ github.event.inputs.mode == 'both' || github.event.inputs.mode == 'frontend' || github.event_name == 'schedule' }}

    permissions:
      contents: write

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Debug Vars
        run: |
          echo "vars.SUPABASE_URL: ${{ vars.SUPABASE_URL }}"
          echo "vars.SUPABASE_ANON_KEY: ${{ vars.SUPABASE_ANON_KEY }}"

      - name: Before replace
        run: |
          echo "--- Content before sed ---"
          head -n 20 js/supabase_client.js

      - name: Replace placeholders
        run: |
          sed -i "s|%SUPABASE_URL%|${{ vars.SUPABASE_URL }}|g" ./js/supabase_client.js
          sed -i "s|%SUPABASE_ANON_KEY%|${{ vars.SUPABASE_ANON_KEY }}|g" ./js/supabase_client.js

      - name: Verify
        run: |
          if grep -q "%SUPABASE_URL%" ./js/supabase_client.js; then
            echo "❌替换未成功，终止部署"; exit 1;
          else
            echo "✅占位符替换成功"
          fi

      - name: After replace
        run: |
          echo "--- Content after sed ---"
          head -n 20 js/supabase_client.js

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./