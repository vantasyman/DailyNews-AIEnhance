# .github/workflows/run_analysis.yml
name: AI Trend Analysis & Deploy Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  # --- 任务 1: 后端自动化脚本 (保持不变) ---
  run-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -r scripts/pyproject.toml --system

      - name: Run Python Automation Pipeline
        env:
          # --- 数据库密钥 (来自 GitHub Secrets) ---
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          
          # --- API 密钥 (来自 GitHub Secrets) ---
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          
          # --- 配置 (来自 GitHub Variables) ---
          MODEL_NAME: ${{ vars.MODEL_NAME || 'deepseek-chat' }}
          LANGUAGE: ${{ vars.LANGUAGE || 'Chinese' }}
          
          # ⬇️ 【新增】将 GitHub Variable 注入到环境变量中
          TRACKED_TOPICS: ${{ vars.TRACKED_TOPICS || '' }}
          
        run: python -m scripts.main

  # --- 任务 2: 构建和部署前端 (已添加调试步骤) ---
  deploy-pages:
    runs-on: ubuntu-latest
    needs: run-analysis

    permissions:
      contents: write

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 打印变量
      - name: 'Debug: 打印变量'
        run: |
          echo "vars.SUPABASE_URL is: ${{ vars.SUPABASE_URL }}"
          echo "vars.SUPABASE_ANON_KEY is: ${{ vars.SUPABASE_ANON_KEY }}"

      # 打印替换前内容
      - name: 'Debug: 打印替换前的文件'
        run: |
          echo "--- Content before sed ---"
          head -n 20 js/supabase_client.js

      # 替换占位符（确定路径正确）
      - name: 替换前端 JS 中的占位符
        run: |
          sed -i "s|%SUPABASE_URL%|${{ vars.SUPABASE_URL }}|g" ./js/supabase_client.js
          sed -i "s|%SUPABASE_ANON_KEY%|${{ vars.SUPABASE_ANON_KEY }}|g" ./js/supabase_client.js

      # 验证替换成功
      - name: 验证替换是否生效
        run: |
          echo "--- 校验替换结果 ---"
          if grep -q "%SUPABASE_URL%" ./js/supabase_client.js; then
            echo "❌ 替换失败，占位符仍然存在！"; exit 1
          else
            echo "✅ 替换成功：文件中已包含真实 URL。"
          fi

      - name: 'Debug: 打印替换后的文件'
        run: |
          echo "--- Content after sed ---"
          head -n 20 js/supabase_client.js

      # 最后部署
      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./