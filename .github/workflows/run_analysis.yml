# .github/workflows/run_analysis.yml
name: AI Trend Analysis & Deploy Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  # --- ä»»åŠ¡ 1: åç«¯è‡ªåŠ¨åŒ–è„šæœ¬ (ä¿æŒä¸å˜) ---
  run-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -r scripts/pyproject.toml --system

      - name: Run Python Automation Pipeline
        env:
          # --- æ•°æ®åº“å¯†é’¥ (æ¥è‡ª GitHub Secrets) ---
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          
          # --- API å¯†é’¥ (æ¥è‡ª GitHub Secrets) ---
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          
          # --- é…ç½® (æ¥è‡ª GitHub Variables) ---
          MODEL_NAME: ${{ vars.MODEL_NAME || 'deepseek-chat' }}
          LANGUAGE: ${{ vars.LANGUAGE || 'Chinese' }}
          
          # â¬‡ï¸ ã€æ–°å¢ã€‘å°† GitHub Variable æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­
          TRACKED_TOPICS: ${{ vars.TRACKED_TOPICS || '' }}
          
        run: python -m scripts.main

  # --- ä»»åŠ¡ 2: æ„å»ºå’Œéƒ¨ç½²å‰ç«¯ (ä¿®æ”¹ä¸ºæ–¹æ¡ˆä¸€) ---
  deploy-pages:
    runs-on: ubuntu-latest
    needs: run-analysis
    
    # ã€ä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†éœ€è¦å†™å…¥ main åˆ†æ”¯çš„æƒé™ï¼Œå¯ä»¥ç§»é™¤ permissions
    # permissions:
    #   contents: write 

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # ä½ çš„è°ƒè¯•æ­¥éª¤å¾ˆå¥½ï¼Œæˆ‘ä»¬ä¿ç•™å®ƒ
      - name: ğŸ” è°ƒè¯•ï¼šéªŒè¯ä»“åº“æ–‡ä»¶å­˜åœ¨
        run: |
          pwd
          ls -R | head -n 200
          echo "===== ç¡®è®¤ js æ–‡ä»¶å­˜åœ¨ ====="
          find . -name supabase_client.js

      - name: âš™ï¸ æ›¿æ¢å‰ç«¯å ä½ç¬¦
        run: |
          echo "--- æ›¿æ¢å‰ ---"
          grep SUPABASE_URL js/supabase_client.js || true
          sed -i "s|%SUPABASE_URL%|${{ vars.SUPABASE_URL }}|g" js/supabase_client.js
          sed -i "s|%SUPABASE_ANON_KEY%|${{ vars.SUPABASE_ANON_KEY }}|g" js/supabase_client.js
          echo "--- æ›¿æ¢å ---"
          grep SUPABASE_URL js/supabase_client.js || true

      # ã€ä¿®æ”¹ã€‘è¿™æ˜¯æ–¹æ¡ˆä¸€çš„éƒ¨ç½²æ­¥éª¤
      - name: ğŸš€ éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./         # éƒ¨ç½²ç›®å½•ï¼šä»“åº“æ ¹ç›®å½•
          # ã€ç§»é™¤ã€‘ publish_branch: main  (ç§»é™¤æ­¤è¡Œï¼ŒåŠ¨ä½œå°†è‡ªåŠ¨æ¨é€åˆ° gh-pages)
          # ã€ç§»é™¤ã€‘ keep_files: true       (ç§»é™¤æ­¤è¡Œï¼Œä»¥è¿›è¡Œâ€œå¹²å‡€â€éƒ¨ç½²)
          allow_empty_commit: true