# .github/workflows/run_analysis.yml
name: AI Trend Analysis & Deploy Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  # --- 任务 1: 后端自动化脚本 ---
  run-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -r scripts/pyproject.toml

      - name: Run Python Automation Pipeline
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL_NAME: ${{ vars.MODEL_NAME || 'deepseek-chat' }}
          LANGUAGE: ${{ vars.LANGUAGE || 'Chinese' }}
        run: python -m scripts.main

  # --- 任务 2: 构建和部署前端 ---
  # (此任务会在 任务 1 成功后运行)
  deploy-pages:
    runs-on: ubuntu-latest
    needs: run-analysis # ⬅️ 确保在分析任务成功后才部署

    # 授予 GITHUB_TOKEN 写入 gh-pages 分支的权限
    permissions:
      contents: write

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: 替换前端 JS 中的占位符
        run: |
          # 使用 'sed' 命令查找并替换占位符
          # 注意：我们使用 vars.SUPABASE_URL 和 vars.SUPABASE_ANON_KEY
          sed -i "s|%SUPABASE_URL%|${{ vars.SUPABASE_URL }}|g" js/supabase_client.js
          sed -i "s|%SUPABASE_ANON_KEY%|${{ vars.SUPABASE_ANON_KEY }}|g" js/supabase_client.js

      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # 指定要部署的文件夹 (包含 HTML, CSS, 和已修改的 JS)
          publish_dir: ./
          # (可选) 如果你的仓库是私有的，可能需要这个
          # personal_token: ${{ secrets.GH_PAGES_TOKEN }}